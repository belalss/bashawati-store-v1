"use client";

import React from "react";
import { addItemToCart, getCartCount, getCart, setItemQuantity, removeItem } from "@/lib/cart";

import { buildWhatsAppUrl } from "@/lib/whatsapp";
import CartDrawer from "@/components/CartDrawer";


const STORE = {
  name: "Ø§Ù„Ø¨Ø´Ø§ÙˆØ§ØªÙŠ",
  whatsapp: "962799304026",
};

const products = [
  {
    id: "1",
    name: "ÙƒÙ†Ø§ÙØ© Ù†Ø§Ø¨Ù„Ø³ÙŠØ©",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/knafeh.jpg",
    options: [
      { label: "Ù†ØµÙ ÙƒÙŠÙ„Ùˆ", price: 2.75 },
      { label: "ÙƒÙŠÙ„Ùˆ", price: 5.5 },
    ],
  },
  {
    id: "2",
    name: "Ø¨Ù‚Ù„Ø§ÙˆØ© Ù…Ø´ÙƒÙ„Ø©",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/Bklava.jpg",
    options: [
      { label: "Ù†ØµÙ ÙƒÙŠÙ„Ùˆ", price: 8 },
      { label: "ÙƒÙŠÙ„Ùˆ", price: 16 },
    ],
  },
  {
    id: "3",
    name: " Ø¬Ø§ØªÙˆ",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/Jato.jpg",
    options: [
      { label: "Ù‚Ø§Ù„Ø¨ ÙƒØ¨ÙŠØ± ", price: 9 },
      { label: "Ù‚Ø§Ù„Ø¨ ÙˆØ³Ø·", price: 7 },
      { label: "Ù‚Ø§Ù„Ø¨ ØµØºÙŠØ± ", price: 5 },
    ],
  },
  {
    id: "4",
    name: "ÙƒÙ†Ø§ÙØ© Ù†Ø§Ø¨Ù„Ø³ÙŠØ©",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/knafeh.jpg",
    options: [
      { label: "Ù†ØµÙ ÙƒÙŠÙ„Ùˆ", price: 2.75 },
      { label: "ÙƒÙŠÙ„Ùˆ", price: 5.5 },
    ],
  },
  {
    id: "5",
    name: "Ø¨Ù‚Ù„Ø§ÙˆØ© Ù…Ø´ÙƒÙ„Ø©",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/Bklava.jpg",
    options: [
      { label: "Ù†ØµÙ ÙƒÙŠÙ„Ùˆ", price: 8 },
      { label: "ÙƒÙŠÙ„Ùˆ", price: 16 },
    ],
  },
  {
    id: "6",
    name: " Ø¬Ø§ØªÙˆ",
    description: "Ø·Ø§Ø²Ø¬Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ØŒ Ø¬Ø¨Ù†Ø© Ù†Ø§Ø¨Ù„Ø³ÙŠØ© Ø£ØµÙ„ÙŠØ©.",
    Image: "/images/Jato.jpg",
    options: [
      { label: "Ù‚Ø§Ù„Ø¨ ÙƒØ¨ÙŠØ± ", price: 9 },
      { label: "Ù‚Ø§Ù„Ø¨ ÙˆØ³Ø·", price: 7 },
      { label: "Ù‚Ø§Ù„Ø¨ ØµØºÙŠØ± ", price: 5 },
    ],
  },
];

export default function Home() {
  //return <div style={{ padding: 20 }}>TEST: page is rendering âœ…</div>;
  // âœ… Ø§Ù„Ø­Ø§Ù„Ø© (State) â€” Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù‡Ù†Ø§
  const [cartCount, setCartCount] = React.useState(0);
  const [drawerOpen, setDrawerOpen] = React.useState(false);
const [cart, setCart] = React.useState([]);
const [total, setTotal] = React.useState(0);
const [customer, setCustomer] = React.useState({
  name: "",
  phone: "",
  address: "",
});


//React.useEffect(()=>{setCartCount(99);},[cart])
  // âœ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
React.useEffect(() => {
  const c = getCart();
  setCart(c);
  setTotal(c.reduce((sum, item) => sum + item.price * item.quantity, 0));
  setCartCount(getCartCount());
  //setCartCount(123);
}, []);




  // âœ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
  const addToCart = (product, option) => {
  addItemToCart(product, option);

  const c = getCart();
  setCart(c);
  setTotal(c.reduce((sum, item) => sum + item.price * item.quantity, 0));
  setCartCount(getCartCount());
};


  // âœ… Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ù„Ø© (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  const viewCart = () => {
    alert(JSON.stringify(getCart(), null, 2));
    
  };
  const sendToWhatsApp = () => {
  if (!customer.name || !customer.phone || !customer.address) {
    alert("Please fill Name, Phone, and Address");
    return;
  }

  const url = buildWhatsAppUrl({
  phone: STORE.whatsapp,
  cart: cart,
  storeName: STORE.name,
  customer: customer,
});


  if (!url) {
    alert("Cart is empty");
    return;
  }

  window.open(url, "_blank");
};

const recalc = () => {
  const c = getCart();
  setCart(c);
  setTotal(c.reduce((sum, item) => sum + item.price * item.quantity, 0));
  setCartCount(getCartCount());
};
const incItem= (item) => {
  setItemQuantity(item.productId, item.optionLabel, item.quantity + 1);
  recalc();
};

const decItem = (item) => {
  setItemQuantity(item.productId, item.optionLabel, item.quantity - 1); // B: Ù„Ù† ØªÙ†Ø²Ù„ ØªØ­Øª 1
  recalc();
};

const removeCartItem = (item) => {
  removeItem(item.productId, item.optionLabel);
  recalc();
};

    return  (
      
    <div className="container">
      <div className="header">
        <h1>My First Store</h1>
        <div>
          <button className="btn" onClick={() => setDrawerOpen(true)}>
  ğŸ›’ {cartCount}
</button>
  {/*<button onClick={viewCart} className="btn" style={{ marginLeft: 10 }}>
            View cart
          </button>
  */}
          <button onClick={sendToWhatsApp} className="btn" style={{ marginLeft: 10 }}>
  Send via WhatsApp
</button>

        </div>
      </div>

      <div className="grid">

        {products.map((p) => (
          <div key={p.id} className="card">
            <img
            src={p.Image}
            alt={p.name}
            className="product-image"
             />
            <h2>{p.name}</h2>
            <p className="desc">{p.description}</p>

            {p.options.map((opt) => (
              <div key={opt.label} className="optionRow">
                <span>
                  {opt.label} - {opt.price} JD
                </span>

                <button className="btn" onClick={() => addToCart(p, opt)}>
                  Add to cart
                </button>
              </div>
            ))}
          </div>
        ))}
      </div>
      <CartDrawer
  open={drawerOpen}
  onClose={() => setDrawerOpen(false)}
  cart={cart}
  total={total}
  onSend={sendToWhatsApp}
  onInc={incItem}
  onDec={decItem}
  onRemove={removeCartItem}
  customer={customer}
  onCustomerChange={setCustomer}
/>



    </div>
  );

}
